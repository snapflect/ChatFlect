# Crypto Assets Inventory (TASK 1.2-A) - ChatFlect

This document provides a definitive catalog of every cryptographic key type used in ChatFlect, satisfying the P0 requirements for STORY-1.2.

## 1. Key Inventory Table

| Key Name | Key Type | Scope | User/Device/Session Generated By | Stored In | Transmitted To | Expiry/Rotation Policy |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **Master Private Key** | RSA | Device | `AuthService` (Post-OTP/OAuth) | iOS Keychain / Android Keystore / `secure_` localStorage | **Never** | Manual (User Triggered) |
| **Master Public Key** | RSA | Device | `AuthService` (Post-OTP/OAuth) | MySQL (`user_devices`) / localStorage | Backend (MySQL) / Recipient (Discovery) | None (Syncs with Private Key) |
| **v1 Session Key** | AES | Message | `CryptoService.encryptAesKeyForRecipient` | Memory Only | Recipient (RSA Encrypted Envelope) | Per-Message (None) |
| **v2 Ratchet Root Key**| AES | Session | `CryptoService.encryptWithRatchet` (Bootstrap) | localStorage | Recipient (RSA Encrypted Header) | Per-Session |
| **Ratchet Chain Key** | AES | Session | `CryptoService.kdfChain` | localStorage | **Never** | Per-Message (KDF Step) |
| **Ratchet Message Key**| AES | Message | `CryptoService.kdfChain` | Memory Only | **Never** | One-Time Use |
| **HMAC Integrity Key** | HMAC | Device | `CryptoService.generateSigningKey` | localStorage | Recipient (In-Band with Session) | Managed with Session |
| **Media Encryption Key**| AES | Message/Asset | `CryptoService.encryptBlob` | Firestore (Encrypted Field) | Recipient (In-Band with Media Link) | Per-Media Upload |
| **Link Handshake Key** | RSA | Ephemeral | `LinkService.generateLinkSession` | Memory (Desktop App) | Mobile Device (Scan QR) | Ephemeral (< 5 Mins) |
| **Storage Wrap Key** | AES | Device | `SecureStorageService.initWebFallback` | Volatile (Derived) | **Never** | Per-App Session (Re-derived) |

---

## 2. Technical Audit Details

### Identity Keys (Master Private Key)
- **Algorithm**: RSA-OAEP 2048-bit (SHA-256).
- **Function**: Decrypting session keys and authenticating session handshakes.
- **Persistence**: Stored in the most secure location available on the platform (Keychain/Keystore).

### Device Keys
- **Definition**: In ChatFlect, "Device Keys" refers to the specific `Master Public Key` associated with a `device_uuid` in the `user_devices` table.
- **Discovery**: Fetched via `keys.php?user_id=...` to facilitate multi-device fan-out.

### Session/Message Keys
- **Hybrid (v1)**: 256-bit AES-GCM keys generated per message and wrapped with RSA.
- **Ratchet (v2)**: 256-bit AES-GCM keys derived from a rolling chain (KDF) providing Forward Secrecy.

### Ephemeral Handshake Keys (Desktop Sync)
- **Purpose**: Secures the transfer of the Master Private Key from Mobile to Desktop during "Linked Devices" setup.
- **Handshake**: Desktop generates RSA-2048 pair -> Display PubKey in QR -> Mobile scans -> Mobile encrypts Master Key with Desktop PubKey -> Uploads to `sync_requests` collection.

### Storage Wrap Keys (localStorage fallback)
- **Algorithm**: AES-GCM 256-bit.
- **Derivation**: `PBKDF2-HMAC-SHA256` (100k iterations).
- **Salt**: `ChatFlect_SecureStorage_Salt`.
- **Source**: Browser/Device Fingerprint string.

---

## 3. Compliance Confirmation

- [x] Every key name matches the source code implementation in `CryptoService` and `LinkService`.
- [x] All storage locations (Keychain, Keystore, localStorage, MySQL, Firestore) accounted for.
- [x] Transmission boundaries (Never vs Backend vs Recipient) explicitly defined.
- [x] No hidden keys were discovered during the audit of `LinkService` and `SecureStorageService`.
