# Key Lifecycle Matrix (TASK 1.2-F) - ChatFlect

This document defines the comprehensive operational lifecycle for every cryptographic key in the system, satisfying the P0 requirements of STORY-1.2.

## 1. Key Lifecycle Table

| Key Type | Creation Trigger | Rotation Trigger | Revocation Trigger | Expiry | Destruction Method | Backup Rules |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **Master Identity Key (Private)** | First Login / OTP Verification | Manual (User-Initiated) | Logout / Device Revocation | Never (Static) | SecureStore.remove() | Not Backed Up |
| **Master Identity Key (Public)** | First Login / OTP Verification | Syncs with Private Key | Device Deletion on Backend | Never (Static) | MySQL DELETE | Stored in MySQL |
| **Device Keys** | Desktop Linking / Multi-Device Pairing | Manual | Unlinking Device | Never (Per-Device) | SecureStore.remove() | Not Backed Up |
| **AES Session Key (v1)** | Every Message Send | Per-Message (New Key) | Never (Single-Use) | Immediate | Memory GC | Not Backed Up |
| **Ratchet Root Key** | First Message in Ratchet Session | None (Per-Session) | Session Reset/Conflict | Session Duration | localStorage.clear() | Not Backed Up |
| **Chain Key (Send/Recv)** | Every Message Send/Recv | Automatic (KDF Step) | Never (Ephemeral) | Per-Message | Memory GC | Not Backed Up |
| **Ephemeral Sync Key (Desktop)** | Desktop QR Scan | Never | Handshake Completion | ~60 seconds | Memory GC | Not Backed Up |
| **Backup Export Key** | Manual Export Request | Never | N/A | N/A | User Responsibility | User-Controlled File |

---

## 2. Generation Procedures

1.  **Identity Keys**: Generated during `verifyOtp` using `window.crypto.subtle.generateKey("RSA-OAEP")`.
2.  **Ratchet Initiation**: In `encryptWithRatchet`, if no session exists, a 32-byte `rootKey` is generated via `getRandomValues`.
3.  **Ephemeral Sync Key**: Generated by `LinkService.generateEphemeralKey()` for one-time desktop pairing.

---

## 3. End-of-Life Behavior

| Key Type | End-of-Life Trigger | Behavior |
| :--- | :--- | :--- |
| **Master Identity Key (Private)** | Logout or Device Revocation | Deleted from SecureStore; backend public key removed via `devices.php?action=delete`. |
| **AES Session Key** | Message Delivered | Dereferenced and eligible for JavaScript garbage collection. |
| **Ratchet Keys** | Session Reset or Logout | Cleared via `localStorage.clear()`. |
| **Ephemeral Sync Key** | Handshake Complete | Immediately dereferenced; GC'd in memory. |
| **Backup Export Key** | User Deletes File | No automated system control; user responsibility. |

---

## 4. Identified Lifecycle Gaps (Phase 2)

1.  **No Automatic RSA Rotation**: Identity keys are static unless the user manually triggers a rotation or logs out/reinstalls.
2.  **No Key History**: The backend only stores the *current* public key. If a user rotates their keys, they lose access to all messages encrypted with the previous key.
3.  **Weak Private Key Disposal**: If a user uninstalls the app without a "Logout", the private key may remain in the OS Keychain/Keystore indefinitely.
4.  **No Secure Backup System**: Currently, users cannot back up and restore their identity keys. This is a critical Phase 2 feature.
