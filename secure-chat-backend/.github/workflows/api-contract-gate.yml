# API Contract Gate CI Workflow
# Epic 35: Validates OpenAPI + contract tests

name: API Contract Gate

on:
    pull_request:
        paths:
            - "secure-chat-backend/docs/api/openapi.yaml"
            - "secure-chat-backend/relay/**"
            - "secure-chat-backend/api/**"
            - "crypto-tests/integration/contract.test.ts"
    workflow_dispatch:

jobs:
    validate-openapi:
        name: Validate OpenAPI Spec
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install yaml parser
              run: npm install yaml

            - name: Validate OpenAPI
              run: node scripts/validate_openapi.js
              working-directory: secure-chat-backend

    contract-tests:
        name: Contract Tests
        runs-on: ubuntu-latest
        needs: validate-openapi
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: crypto-tests/package-lock.json

            - name: Install dependencies
              run: npm ci
              working-directory: crypto-tests

            - name: Run contract tests
              run: npm test -- integration/contract.test.ts
              working-directory: crypto-tests
              env:
                  API_URL: ${{ secrets.API_URL }}

            - name: Contract Gate Result
              if: failure()
              run: |
                  echo "‚ùå Contract tests FAILED - API may have breaking changes"
                  exit 1
