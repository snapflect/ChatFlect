name: Crypto Tests

on:
  pull_request:
    paths:
      # Frontend crypto services
      - 'secure-chat-app/src/app/services/signal*.ts'
      - 'secure-chat-app/src/app/services/crypto*.ts'
      # Backend crypto endpoints
      - 'secure-chat-backend/api/v3/keys.php'
      - 'secure-chat-backend/api/v3/send_message.php'
      - 'secure-chat-backend/api/devices.php'
      - 'secure-chat-backend/api/auth_middleware.php'
      - 'secure-chat-backend/includes/CryptoUtils.php'
      # Crypto test changes
      - 'crypto-tests/**'
      # Firestore rules (security)
      - 'firestore.rules'

jobs:
  crypto-unit-tests:
    name: Crypto Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: crypto-tests/package-lock.json

      - name: Install Dependencies
        run: npm ci
        working-directory: crypto-tests

      - name: Run Crypto Unit Tests
        run: npm test
        working-directory: crypto-tests

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: crypto-coverage
          path: crypto-tests/coverage/

  firestore-rule-tests:
    name: Firestore Rule Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Install Dependencies
        run: npm ci
        working-directory: firestore-tests

      - name: Run Firestore Rule Tests
        run: firebase emulators:exec --only firestore "cd firestore-tests && npm test"

  security-review:
    name: Security Review Required
    runs-on: ubuntu-latest
    if: |
      contains(github.event.pull_request.changed_files, 'signal') ||
      contains(github.event.pull_request.changed_files, 'crypto') ||
      contains(github.event.pull_request.changed_files, 'keys.php')
    steps:
      - name: Check for Security Approval
        run: |
          echo "⚠️ This PR modifies crypto-sensitive files."
          echo "Manual security review is required before merge."
          echo "Please ensure a security team member has approved."
