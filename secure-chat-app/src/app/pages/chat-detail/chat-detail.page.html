<ion-header class="ion-no-border">
  <ion-toolbar *ngIf="!isSelectionMode" class="chat-header-toolbar">
    <ion-buttons slot="start">
      <ion-button (click)="goBack()" class="back-btn">
        <ion-icon name="arrow-back" slot="icon-only"></ion-icon>
      </ion-button>

      <!-- Avatar in Header: Use Unified SecureSrc -->
      <ion-avatar class="header-avatar" (click)="openContactInfo()">
        <img [secureSrc]="chatPic || 'assets/user.png'" onerror="this.src='assets/user.png'">
      </ion-avatar>
    </ion-buttons>

    <ion-title class="chat-title-group" (click)="openContactInfo()">
      <div class="chat-name">{{ chatName || 'User' }}</div>
      <div class="chat-subtitle" *ngIf="!isGroup">
        <span *ngIf="typingUsers && typingUsers.length > 0; else presenceDisplay" class="typing-text">typing...</span>
        <ng-template #presenceDisplay>
          <span *ngIf="otherUserPresence?.state === 'online'">Online</span>
          <span *ngIf="otherUserPresence?.state !== 'online' && otherUserPresence?.last_changed">
            last seen {{ otherUserPresence.last_changed.seconds * 1000 | date:'shortTime' }}
          </span>
          <span *ngIf="!otherUserPresence">&nbsp;</span>
        </ng-template>
      </div>
      <div class="chat-subtitle" *ngIf="isGroup">
        <span *ngIf="typingUsers && typingUsers.length > 0" class="typing-text">{{ typingUsers.join(', ') }}
          typing...</span>
        <span *ngIf="(!typingUsers || typingUsers.length === 0)">{{ participants?.length || 0 }} participants</span>
      </div>
    </ion-title>

    <ion-buttons slot="end">
      <ion-button (click)="startCall('video')">
        <ion-icon name="videocam"></ion-icon>
      </ion-button>
      <ion-button (click)="startCall('audio')">
        <ion-icon name="call"></ion-icon>
      </ion-button>
      <ion-button (click)="presentChatOptions()">
        <ion-icon name="ellipsis-vertical"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Selection Mode Toolbar -->
  <ion-toolbar *ngIf="isSelectionMode" color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="exitSelectionMode()">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>{{ selectedMessages.size }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="starSelectedMessages()">
        <ion-icon name="star"></ion-icon>
      </ion-button>
      <ion-button (click)="deleteSelectedMessages()">
        <ion-icon name="trash"></ion-icon>
      </ion-button>
      <ion-button (click)="forwardSelectedMessages()">
        <ion-icon name="arrow-redo"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="chat-content" (ionScroll)="onScroll($event)">
  <ion-list lines="none" class="bg-transparent" style="padding-top: 10px; padding-bottom: 20px;">

    <div *ngFor="let msg of filteredMessages; let i = index" class="message-wrapper"
      [class.selected-row]="isSelected(msg.id)">

      <!-- Date Separator -->
      <div *ngIf="shouldShowDateSeparator(i)" class="date-separator">
        <span class="date-chip">{{ getDateLabel(msg.timestamp) }}</span>
      </div>

      <div [class.msg-me]="isMyMsg(msg)" [class.msg-them]="!isMyMsg(msg)" class="msg-item">

        <div class="bubble" (click)="isSelectionMode ? toggleSelection(msg) : null" longPress
          (longPress)="onMessageLongPress(msg)" [class.selected]="isSelected(msg.id)">

          <!-- Sender Name (Group) -->
          <div *ngIf="isGroup && !isMyMsg(msg)" class="sender-name" [style.color]="getSenderColor(msg.senderId)">
            {{ msg.senderName || 'User' }}
          </div>

          <!-- Reply Context -->
          <div *ngIf="msg.replyTo" class="reply-context" (click)="scrollToMessage(msg.replyTo.id)">
            <div class="reply-title">{{ msg.replyTo.senderName || 'User' }}</div>
            <div class="reply-text">{{ msg.replyTo.text?.type ? 'ðŸ“· Photo' : (msg.replyTo.text | slice:0:50) }}</div>
          </div>

          <!-- Forwarded -->
          <div *ngIf="msg.forwarded" class="forwarded-label">
            <ion-icon name="arrow-redo" style="font-size: 10px;"></ion-icon> Forwarded
          </div>

          <!-- Unified Media Handling -->
          <!-- We rely on msg.text being the Metadata Object if it's media -->

          <!-- IMAGE -->
          <div *ngIf="isMedia(msg.text) && (msg.text.type === 'image' || !msg.text.type)" class="media-content">
            <img [secureSrc]="msg.text.url" [pymKey]="isMe ? (msg.text.ks || msg.text.k) : msg.text.k"
              [pymIv]="msg.text.i" class="message-image" (click)="openImage(msg.text)"
              (error)="$event.target.src = 'assets/placeholder_broken.png'" />
            <p *ngIf="msg.text.caption">{{ msg.text.caption }}</p>
          </div>

          <!-- VIDEO -->
          <div *ngIf="getMsgType(msg.text) === 'video'" class="media-content">
            <!-- Video Thumb or Player. SecureSrc sets src. -->
            <video [secureSrc]="msg.text.url" [pymKey]="isMe ? (msg.text.ks || msg.text.k) : msg.text.k"
              [pymIv]="msg.text.i" controls class="message-video"></video>
            <p *ngIf="msg.text.caption">{{ msg.text.caption }}</p>
          </div>

          <!-- AUDIO -->
          <div *ngIf="getMsgType(msg.text) === 'audio'" class="audio-player-new">
            <!-- Use Audio Tag for now, or Custom Player with URL from Directive? 
                  Directive sets src on the element. So <audio [secureSrc]> works. -->
            <audio [secureSrc]="msg.text.url" [pymKey]="isMe ? (msg.text.ks || msg.text.k) : msg.text.k"
              [pymIv]="msg.text.i" controls style="width: 200px; height: 40px;"></audio>
          </div>

          <!-- TEXT -->
          <span *ngIf="getMsgType(msg.text) === 'text'" class="msg-text" [innerHTML]="linkify(msg.text)"></span>

          <!-- Metadata (Time + Status) -->
          <div class="msg-footer">
            <span class="timestamp">{{ msg.timestamp?.seconds * 1000 || msg.timestamp | date:'shortTime' }}</span>
            <ion-icon *ngIf="isMyMsg(msg)" [name]="isRead(msg) ? 'checkmark-done' : 'checkmark-done'"
              [class.read-icon]="isRead(msg)" [class.sent-icon]="!isRead(msg)"></ion-icon>
          </div>

        </div>
      </div>
    </div>
  </ion-list>

  <!-- Scroll FAB -->
  <ion-fab *ngIf="showScrollFab" vertical="bottom" horizontal="end" slot="fixed" class="scroll-fab">
    <ion-fab-button size="small" (click)="scrollToBottom()">
      <ion-icon name="chevron-down"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>

<!-- Footer -->
<ion-footer class="ion-no-border">
  <div *ngIf="replyingTo" class="reply-preview">
    <div class="reply-content">
      <div class="reply-title">Replying to {{ replyingTo.senderName || 'User' }}</div>
      <div class="reply-text">{{ replyingTo.text?.type ? 'Media' : replyingTo.text }}</div>
    </div>
    <ion-button fill="clear" (click)="replyingTo = null">
      <ion-icon name="close" color="medium"></ion-icon>
    </ion-button>
  </div>

  <div class="chat-footer">
    <ion-button fill="clear" class="action-btn" (click)="toggleStickerPicker()">
      <ion-icon name="happy-outline" slot="icon-only"></ion-icon>
    </ion-button>

    <div class="input-container">
      <textarea rows="1" placeholder="Message" [(ngModel)]="newMessage" (ngModelChange)="onTyping()"
        class="chat-input"></textarea>
      <ion-button fill="clear" class="action-btn" (click)="presentAttachmentMenu()">
        <ion-icon name="attach" slot="icon-only" style="transform: rotate(45deg);"></ion-icon>
      </ion-button>
      <ion-button *ngIf="!newMessage" fill="clear" class="action-btn" style="margin-left: -5px;">
        <ion-icon name="camera" slot="icon-only"></ion-icon>
      </ion-button>
    </div>

    <!-- Record or Send Button -->
    <div class="mic-btn" *ngIf="!newMessage" (click)="recordAudio()">
      <ion-icon name="mic"></ion-icon>
    </div>
    <div class="send-btn" *ngIf="newMessage" (click)="sendMessage()">
      <ion-icon name="send"></ion-icon>
    </div>
  </div>
</ion-footer>