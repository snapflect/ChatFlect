<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()" color="medium">
        <ion-icon name="arrow-back" style="font-size: 24px;"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title class="gradient-text" (click)="openGroupInfo()">
      <div class="chat-title-row">
        {{ chatName }}
        <ion-icon *ngIf="isGroup" name="information-circle-outline"
          style="font-size: 0.8em; margin-left: 5px;"></ion-icon>
      </div>

      <!-- SUBTITLE: PRESENCE / TYPING -->
      <div class="chat-subtitle" *ngIf="!isGroup">
        <span *ngIf="typingUsers.length > 0" class="typing-text">typing...</span>
        <ng-container *ngIf="typingUsers.length === 0 && otherUserPresence">
          <span *ngIf="otherUserPresence.state === 'online'" class="online-text">‚óè Online</span>
          <span *ngIf="otherUserPresence.state !== 'online'" class="offline-text">Last seen {{
            otherUserPresence.last_changed?.seconds * 1000 | date:'shortTime' }}</span>
        </ng-container>
      </div>
      <div class="chat-subtitle" *ngIf="isGroup && typingUsers.length > 0">
        <span class="typing-text">Someone is typing...</span>
      </div>
    </ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="toggleSearch()">
        <ion-icon name="search"></ion-icon>
      </ion-button>
      <ion-button (click)="openChatInfo()">
        <ion-icon name="ellipsis-vertical"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  <ion-toolbar *ngIf="isSearchActive">
    <ion-searchbar (ionInput)="onSearch($event)" placeholder="Search in chat..." showCancelButton="always"
      (ionCancel)="toggleSearch()"></ion-searchbar>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="chat-content">
  <!-- (Existing List) -->
  <ion-list lines="none" class="bg-transparent ion-padding-top">
    <div *ngFor="let msg of filteredMessages" class="message-wrapper">

      <!-- Date Divider (Optional, skip for now or logic needed) -->

      <div [class.msg-me]="isMyMsg(msg)" [class.msg-them]="!isMyMsg(msg)" class="message-bubble glass-card"
        (press)="presentActionSheet(msg)">

        <!-- Sender Name (Group) -->
        <p *ngIf="isGroup && !isMyMsg(msg)" class="sender-name">{{ msg.senderName || 'User' }}</p>

        <!-- Reply Context -->
        <div *ngIf="msg.replyTo" class="reply-context">
          <div class="reply-bar"></div>
          <p class="reply-text">{{ msg.replyTo.text?.type ? 'Media' : (msg.replyTo.text | slice:0:30) }}...</p>
        </div>

        <!-- Forwarded Label -->
        <p *ngIf="msg.forwarded" class="forwarded-label"><ion-icon name="arrow-redo"></ion-icon> Forwarded</p>

        <div class="msg-content">
          <img *ngIf="isImage(msg.text)" [src]="getImgUrl(msg.text)" (click)="openImage(getImgUrl(msg.text))">
          <img *ngIf="isSticker(msg.text)" [src]="getStickerUrl(msg.text)" class="sticker-img">
          <div
            *ngIf="!isImage(msg.text) && !isSticker(msg.text) && (msg.text?.type !== 'audio' && msg.text?.type !== 'location')">
            {{ msg.text }}</div>

          <div *ngIf="msg.text?.type === 'audio'">
            <audio controls [src]="msg.text.url"></audio>
          </div>

          <!-- Location Check -->
          <!-- Ideally add isLocation(msg.text) later -->
        </div>

        <!-- Audio -->
        <div *ngIf="getMsgType(msg.text) === 'audio'" class="audio-player">
          <ion-button fill="clear" (click)="toggleAudio(msg)">
            <ion-icon [name]="msg.isPlaying ? 'pause' : 'play'"></ion-icon>
          </ion-button>
          <div class="audio-track">
            <div class="progress-bar" [style.width.%]="msg.isPlaying ? 50 : 0"></div>
          </div>
          <span class="audio-duration">{{ msg.text.duration || '0:00' }}s</span>
        </div>

        <!-- Document -->
        <div *ngIf="getMsgType(msg.text) === 'document'" class="doc-attachment" (click)="openDocument(msg.text)">
          <ion-icon name="document-text" size="large"></ion-icon>
          <span>{{ msg.text.name || 'Document' }}</span>
        </div>

        <!-- Location -->
        <div *ngIf="getMsgType(msg.text) === 'location'" class="location-bubble"
          (click)="openLocation(msg.text.lat, msg.text.lng)">
          <ion-icon name="location" color="danger"></ion-icon>
          <span>Shared Location</span>
        </div>

        <!-- Text -->
        <div *ngIf="getMsgType(msg.text) === 'text'" class="msg-text">
          {{ msg.text }}
          <!-- Link Preview -->
          <div *ngIf="msg.linkMeta" class="link-preview" (click)="openLink(msg.linkMeta.url)">
            <img *ngIf="msg.linkMeta.image" [src]="msg.linkMeta.image" />
            <div class="link-info">
              <b>{{ msg.linkMeta.domain }}</b>
              <p>{{ msg.linkMeta.title }}</p>
            </div>
          </div>
        </div>

        <!-- Footer: Time + Read Status + Reactions -->
        <div class="msg-footer">
          <span class="timestamp">{{ msg.timestamp?.seconds * 1000 | date:'shortTime' }}</span>
          <ion-icon *ngIf="isMyMsg(msg)" [name]="msg.read ? 'checkmark-done-outline' : 'checkmark-outline'"
            [color]="msg.read ? 'primary' : 'medium'"></ion-icon>

          <!-- Reactions Display -->
          <div *ngIf="getReactionCount(msg) > 0" class="reactions-display">
            <span *ngFor="let r of getTopReactions(msg)">{{ r }}</span>
            <span *ngIf="getReactionCount(msg) > 1" class="reaction-count">{{ getReactionCount(msg) }}</span>
          </div>
        </div>

      </div>
    </div>
  </ion-list>
</ion-content>

<ion-footer class="ion-no-border">
  <!-- Reply Preview -->
  <div *ngIf="replyingTo" class="reply-preview glass-card">
    <div class="reply-bar"></div>
    <p>Replying to: {{ replyingTo.text | slice:0:30 }}...</p>
    <ion-icon name="close" (click)="replyingTo = null"></ion-icon>
  </div>

  <ion-toolbar class="input-toolbar">
    <div class="input-container glass-card" *ngIf="!isRecording; else recordingUI">
      <ion-button fill="clear" (click)="presentAttachmentMenu()" class="icon-btn">
        <ion-icon name="add" slot="icon-only"></ion-icon>
      </ion-button>

      <!-- Input Field -->
      <ion-textarea autoGrow="true" rows="1" placeholder="Type a message..." [(ngModel)]="newMessage"
        (ngModelChange)="onTyping()" class="chat-input-area"></ion-textarea>

      <!-- Sticker Toggle -->
      <ion-button fill="clear" (click)="toggleStickerPicker()">
        <ion-icon name="happy-outline" slot="icon-only"></ion-icon>
      </ion-button>

      <div *ngIf="!newMessage.trim()">
        <ion-button fill="clear" class="icon-btn">
          <ion-icon name="camera-outline" slot="icon-only"></ion-icon>
        </ion-button>
        <ion-button fill="clear" (click)="recordAudio()" class="icon-btn">
          <ion-icon name="mic-outline" slot="icon-only"></ion-icon>
        </ion-button>
      </div>

      <ion-button *ngIf="newMessage.trim()" fill="clear" (click)="sendMessage()" class="send-btn">
        <ion-icon name="send" slot="icon-only"></ion-icon>
      </ion-button>
    </div>

    <!-- Recording UI -->
    <ng-template #recordingUI>
      <div class="input-container glass-card recording-active">
        <ion-button fill="clear" color="danger" (click)="stopRecording(false)">
          <ion-icon name="trash" slot="icon-only"></ion-icon>
        </ion-button>

        <div class="record-timer">
          <div class="rec-dot"></div>
          <span>{{ recordDuration * 1000 | date:'mm:ss' }}</span>
        </div>

        <ion-button fill="clear" color="primary" (click)="stopRecording(true)">
          <ion-icon name="send" slot="icon-only"></ion-icon>
        </ion-button>
      </div>
    </ng-template>
  </ion-toolbar>
</ion-footer>

<style>
  .msg-me {
    margin-left: auto;
    background: #dcf8c6;
    padding: 10px;
    border-radius: 10px;
    max-width: 80%;
    margin-bottom: 5px;
  }

  .msg-them {
    margin-right: auto;
    background: #fff;
    padding: 10px;
    border-radius: 10px;
    max-width: 80%;
    margin-bottom: 5px;
    border: 1px solid #ddd;
  }

  .timestamp {
    font-size: 0.7em;
    color: #888;
    display: block;
    text-align: right;
  }
</style>