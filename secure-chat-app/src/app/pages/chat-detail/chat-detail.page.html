<ion-header class="ion-no-border">
  <ion-toolbar *ngIf="!isSelectionMode" class="chat-header-toolbar">
    <ion-buttons slot="start">
      <ion-button (click)="goBack()" class="back-btn">
        <ion-icon name="arrow-back" slot="icon-only"></ion-icon>
      </ion-button>

      <!-- Avatar in Header -->
      <ion-avatar class="header-avatar" (click)="openContactInfo()">
        <img [src]="chatPic || 'assets/user.png'" onerror="this.src='assets/user.png'">
      </ion-avatar>
    </ion-buttons>

    <ion-title class="chat-title-group" (click)="openContactInfo()">
      <div class="chat-name">{{ chatName }}</div>
      <div class="chat-subtitle" *ngIf="!isGroup">
        <span *ngIf="typingUsers.length > 0; else presenceDisplay" class="typing-text">typing...</span>
        <ng-template #presenceDisplay>
          <span *ngIf="otherUserPresence?.state === 'online'">Online</span>
          <span *ngIf="otherUserPresence?.state !== 'online' && otherUserPresence?.last_changed">
            last seen {{ otherUserPresence.last_changed.seconds * 1000 | date:'shortTime' }}
          </span>
        </ng-template>
      </div>
      <div class="chat-subtitle" *ngIf="isGroup">
        <span *ngIf="typingUsers.length > 0" class="typing-text">{{ typingUsers.join(', ') }} typing...</span>
        <span *ngIf="typingUsers.length === 0">{{ participants.length }} participants</span>
      </div>
    </ion-title>

    <ion-buttons slot="end">
      <ion-button (click)="startCall('video')">
        <ion-icon name="videocam"></ion-icon>
      </ion-button>
      <ion-button (click)="startCall('audio')">
        <ion-icon name="call"></ion-icon>
      </ion-button>
      <ion-button (click)="presentChatOptions()">
        <ion-icon name="ellipsis-vertical"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Selection Mode Toolbar -->
  <ion-toolbar *ngIf="isSelectionMode" color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="exitSelectionMode()">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>{{ selectedMessages.size }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="starSelectedMessages()">
        <ion-icon name="star"></ion-icon>
      </ion-button>
      <ion-button (click)="deleteSelectedMessages()">
        <ion-icon name="trash"></ion-icon>
      </ion-button>
      <ion-button (click)="forwardSelectedMessages()">
        <ion-icon name="arrow-redo"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="chat-content" (ionScroll)="onScroll($event)">
  <ion-list lines="none" class="bg-transparent" style="padding-top: 10px; padding-bottom: 20px;">

    <div *ngFor="let msg of filteredMessages; let i = index" class="message-wrapper"
      [class.selected-row]="isSelected(msg.id)">

      <!-- Date Separator -->
      <div *ngIf="shouldShowDateSeparator(i)" class="date-separator">
        <span class="date-chip">{{ getDateLabel(msg.timestamp) }}</span>
      </div>

      <div [class.msg-me]="isMyMsg(msg)" [class.msg-them]="!isMyMsg(msg)" class="msg-item">

        <div class="bubble" (click)="isSelectionMode ? toggleSelection(msg) : null" longPress
          (longPress)="onMessageLongPress(msg)" [class.selected]="isSelected(msg.id)">

          <!-- Sender Name (Group) -->
          <div *ngIf="isGroup && !isMyMsg(msg)" class="sender-name" [style.color]="getSenderColor(msg.senderId)">
            {{ msg.senderName || 'User' }}
          </div>

          <!-- Reply Context -->
          <div *ngIf="msg.replyTo" class="reply-context" (click)="scrollToMessage(msg.replyTo.id)">
            <div class="reply-title">{{ msg.replyTo.senderName || 'User' }}</div>
            <div class="reply-text">{{ msg.replyTo.text?.type ? 'ðŸ“· Photo' : (msg.replyTo.text | slice:0:50) }}</div>
          </div>

          <!-- Forwarded -->
          <div *ngIf="msg.forwarded" class="forwarded-label">
            <ion-icon name="arrow-redo" style="font-size: 10px;"></ion-icon> Forwarded
          </div>

          <!-- Content: Image -->
          <div *ngIf="isImage(msg.text)">
            <img [src]="getImgUrl(msg.text)" class="msg-image" (click)="openImage(getImgUrl(msg.text))">
            <div *ngIf="msg.text.caption" class="msg-caption">{{ msg.text.caption }}</div>
          </div>

          <!-- Content: Video -->
          <div *ngIf="getMsgType(msg.text) === 'video'" (click)="openVideo(msg.text)">
            <div class="video-thumb-container">
              <img [src]="getImgUrl(msg.text?.thumb) || 'assets/video_placeholder.png'" class="msg-image">
              <div class="play-overlay"><ion-icon name="play-circle"></ion-icon></div>
            </div>
          </div>

          <!-- Content: Audio -->
          <div *ngIf="getMsgType(msg.text) === 'audio'" class="audio-player-new">
            <ion-button fill="clear" (click)="toggleAudio(msg)">
              <ion-icon [name]="msg.isPlaying ? 'pause' : 'play'" slot="icon-only"></ion-icon>
            </ion-button>
            <!-- Waveform / Progress would go here -->
            <span class="audio-duration">{{ msg.text.duration || '0:00' }}</span>
          </div>

          <!-- Content: Text -->
          <span *ngIf="getMsgType(msg.text) === 'text'" class="msg-text" [innerHTML]="linkify(msg.text)"></span>

          <!-- Metadata (Time + Status) -->
          <div class="msg-footer">
            <span class="timestamp">{{ msg.timestamp?.seconds * 1000 || msg.timestamp | date:'shortTime' }}</span>
            <ion-icon *ngIf="isMyMsg(msg)" [name]="isRead(msg) ? 'checkmark-done' : 'checkmark-done'"
              [class.read-icon]="isRead(msg)" [class.sent-icon]="!isRead(msg)"></ion-icon>
          </div>

        </div>
      </div>
    </div>
  </ion-list>

  <!-- Scroll FAB -->
  <ion-fab *ngIf="showScrollFab" vertical="bottom" horizontal="end" slot="fixed" class="scroll-fab">
    <ion-fab-button size="small" (click)="scrollToBottom()">
      <ion-icon name="chevron-down"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>

<!-- Footer -->
<ion-footer class="ion-no-border">
  <div *ngIf="replyingTo" class="reply-preview">
    <div class="reply-content">
      <div class="reply-title">Replying to {{ replyingTo.senderName || 'User' }}</div>
      <div class="reply-text">{{ replyingTo.text?.type ? 'Media' : replyingTo.text }}</div>
    </div>
    <ion-button fill="clear" (click)="replyingTo = null">
      <ion-icon name="close" color="medium"></ion-icon>
    </ion-button>
  </div>

  <div class="chat-footer">
    <ion-button fill="clear" class="action-btn" (click)="toggleStickerPicker()">
      <ion-icon name="happy-outline" slot="icon-only"></ion-icon>
    </ion-button>

    <div class="input-container">
      <textarea rows="1" placeholder="Message" [(ngModel)]="newMessage" (ngModelChange)="onTyping()"
        class="chat-input"></textarea>
      <ion-button fill="clear" class="action-btn" (click)="presentAttachmentMenu()">
        <ion-icon name="attach" slot="icon-only" style="transform: rotate(45deg);"></ion-icon>
      </ion-button>
      <ion-button *ngIf="!newMessage" fill="clear" class="action-btn" style="margin-left: -5px;">
        <ion-icon name="camera" slot="icon-only"></ion-icon>
      </ion-button>
    </div>

    <!-- Record or Send Button -->
    <div class="mic-btn" *ngIf="!newMessage" (click)="recordAudio()">
      <ion-icon name="mic"></ion-icon>
    </div>
    <div class="send-btn" *ngIf="newMessage" (click)="sendMessage()">
      <ion-icon name="send"></ion-icon>
    </div>
  </div>
</ion-footer>