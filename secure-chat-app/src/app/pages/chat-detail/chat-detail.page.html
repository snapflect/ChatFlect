<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()" color="medium">
        <ion-icon name="arrow-back" style="font-size: 24px;"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title class="gradient-text" (click)="openGroupInfo()">
      <div class="chat-title-row">
        {{ chatName }}
        <ion-icon *ngIf="isGroup" name="information-circle-outline"
          style="font-size: 0.8em; margin-left: 5px;"></ion-icon>
      </div>

      <!-- SUBTITLE: PRESENCE / TYPING -->
      <div class="chat-subtitle" *ngIf="!isGroup">
        <span *ngIf="typingUsers.length > 0" class="typing-text">typing...</span>
        <ng-container *ngIf="typingUsers.length === 0 && otherUserPresence">
          <span *ngIf="otherUserPresence.state === 'online'" class="online-text">‚óè Online</span>
          <span *ngIf="otherUserPresence.state !== 'online'" class="offline-text">Last seen {{
            otherUserPresence.last_changed?.seconds * 1000 | date:'shortTime' }}</span>
        </ng-container>
      </div>
      <div class="chat-subtitle" *ngIf="isGroup && typingUsers.length > 0">
        <span class="typing-text">Someone is typing...</span>
      </div>
    </ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="makeCall('video')">
        <ion-icon name="videocam" slot="icon-only" color="secondary"></ion-icon>
      </ion-button>
      <ion-button (click)="makeCall('audio')">
        <ion-icon name="call" slot="icon-only" color="secondary"></ion-icon>
      </ion-button>
      <ion-button (click)="openChatInfo()">
        <ion-icon name="ellipsis-vertical"></ion-icon>
      </ion-button>
    </ion-buttons>
    <!-- Possible avatar or name here in future -->
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="chat-content">
  <!-- (Existing List) -->
  <ion-list lines="none" class="bg-transparent ion-padding-top">
    <!-- ... -->
  </ion-list>
</ion-content>

<ion-footer class="ion-no-border">
  <!-- Reply Preview -->
  <div *ngIf="replyingTo" class="reply-preview glass-card">
    <div class="reply-bar"></div>
    <p>Replying to: {{ replyingTo.text | slice:0:30 }}...</p>
    <ion-icon name="close" (click)="replyingTo = null"></ion-icon>
  </div>

  <ion-toolbar class="input-toolbar">
    <div class="input-container glass-card" *ngIf="!isRecording; else recordingUI">
      <ion-button fill="clear" (click)="presentAttachmentMenu()" class="icon-btn">
        <ion-icon name="add" slot="icon-only"></ion-icon>
      </ion-button>

      <ion-input placeholder="Type a secure message..." [(ngModel)]="newMessage" (ngModelChange)="onTyping()"
        class="msg-input"></ion-input>

      <div *ngIf="!newMessage.trim()">
        <ion-button fill="clear" class="icon-btn">
          <ion-icon name="camera-outline" slot="icon-only"></ion-icon>
        </ion-button>
        <ion-button fill="clear" (click)="recordAudio()" class="icon-btn">
          <ion-icon name="mic-outline" slot="icon-only"></ion-icon>
        </ion-button>
      </div>

      <ion-button *ngIf="newMessage.trim()" fill="clear" (click)="sendMessage()" class="send-btn">
        <ion-icon name="send" slot="icon-only"></ion-icon>
      </ion-button>
    </div>

    <!-- Recording UI -->
    <ng-template #recordingUI>
      <div class="input-container glass-card recording-active">
        <ion-button fill="clear" color="danger" (click)="stopRecording(false)">
          <ion-icon name="trash" slot="icon-only"></ion-icon>
        </ion-button>

        <div class="record-timer">
          <div class="rec-dot"></div>
          <span>{{ recordDuration * 1000 | date:'mm:ss' }}</span>
        </div>

        <ion-button fill="clear" color="primary" (click)="stopRecording(true)">
          <ion-icon name="send" slot="icon-only"></ion-icon>
        </ion-button>
      </div>
    </ng-template>
  </ion-toolbar>
</ion-footer>

<style>
  .msg-me {
    margin-left: auto;
    background: #dcf8c6;
    padding: 10px;
    border-radius: 10px;
    max-width: 80%;
    margin-bottom: 5px;
  }

  .msg-them {
    margin-right: auto;
    background: #fff;
    padding: 10px;
    border-radius: 10px;
    max-width: 80%;
    margin-bottom: 5px;
    border: 1px solid #ddd;
  }

  .timestamp {
    font-size: 0.7em;
    color: #888;
    display: block;
    text-align: right;
  }
</style>