<ion-header class="ion-no-border">
  <ion-toolbar *ngIf="!isSelectionMode" class="chat-header-toolbar">
    <ion-buttons slot="start">
      <ion-button (click)="goBack()" class="back-btn">
        <ion-icon name="arrow-back" slot="icon-only"></ion-icon>
      </ion-button>

      <!-- Avatar in Header: Use Unified SecureSrc -->
      <ion-avatar class="header-avatar" (click)="openContactInfo()">
        <img [secureSrc]="chatPic || 'assets/user.png'" onerror="this.src='assets/user.png'">
      </ion-avatar>
    </ion-buttons>

    <ion-title class="chat-title-group" (click)="openContactInfo()">
      <div class="chat-name">
        {{ chatName || 'User' }}
        <ion-icon name="time-outline" *ngIf="chatDetails?.autoDeleteTimer > 0" class="disappearing-icon"
          style="font-size: 0.8em; color: var(--ion-color-medium); vertical-align: middle; margin-left: 5px;"></ion-icon>
      </div>
      <div class="chat-subtitle" *ngIf="!isGroup">
        <span *ngIf="typingUsers && typingUsers.length > 0; else presenceDisplay" class="typing-text">typing...</span>
        <ng-template #presenceDisplay>
          <span *ngIf="otherUserPresence?.state === 'online'">Online</span>
          <span *ngIf="otherUserPresence?.state !== 'online' && otherUserPresence?.last_changed">
            last seen {{ otherUserPresence.last_changed.seconds * 1000 | date:'shortTime' }}
          </span>
          <span *ngIf="!otherUserPresence">&nbsp;</span>
        </ng-template>
      </div>
      <div class="chat-subtitle" *ngIf="isGroup">
        <span *ngIf="typingUsers && typingUsers.length > 0" class="typing-text">{{ typingUsers.join(', ') }}
          typing...</span>
        <span *ngIf="(!typingUsers || typingUsers.length === 0)">{{ participants?.length || 0 }} participants</span>
      </div>
    </ion-title>

    <ion-buttons slot="end">
      <ion-button (click)="startCall('video')">
        <ion-icon name="videocam"></ion-icon>
      </ion-button>
      <ion-button (click)="startCall('audio')">
        <ion-icon name="call"></ion-icon>
      </ion-button>
      <ion-button (click)="presentChatOptions()">
        <ion-icon name="ellipsis-vertical"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Selection Mode Toolbar -->
  <ion-toolbar *ngIf="isSelectionMode" color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="exitSelectionMode()">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>{{ selectedMessages.size }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="starSelectedMessages()">
        <ion-icon name="star"></ion-icon>
      </ion-button>
      <ion-button (click)="deleteSelectedMessages()">
        <ion-icon name="trash"></ion-icon>
      </ion-button>
      <ion-button (click)="forwardSelectedMessages()">
        <ion-icon name="arrow-redo"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="chat-content" (ionScroll)="onScroll($event)">
  <ion-list lines="none" class="bg-transparent" style="padding-top: 10px; padding-bottom: 20px;">

    <div *ngFor="let msg of filteredMessages; let i = index; trackBy: trackByMsgId" class="message-wrapper"
      [class.selected-row]="isSelected(msg.id)">

      <!-- Date Separator -->
      <div *ngIf="shouldShowDateSeparator(i)" class="date-separator">
        <span class="date-chip">{{ getDateLabel(msg.timestamp) }}</span>
      </div>

      <div [class.msg-me]="isMyMsg(msg)" [class.msg-them]="!isMyMsg(msg)" class="msg-item">

        <div class="bubble" (click)="isSelectionMode ? toggleSelection(msg) : null" longPress
          (longPress)="onMessageLongPress(msg)" [class.selected]="isSelected(msg.id)">

          <!-- Sender Name (Group) -->
          <div *ngIf="isGroup && !isMyMsg(msg)" class="sender-name" [style.color]="getSenderColor(msg.senderId)">
            {{ msg.senderName || 'User' }}
          </div>

          <!-- Reply Context -->
          <div *ngIf="msg.replyTo" class="reply-context" (click)="scrollToMessage(msg.replyTo.id)">
            <div class="reply-title">{{ msg.replyTo.senderName || 'User' }}</div>
            <div class="reply-text">{{ msg.replyTo.text?.type ? 'ðŸ“· Photo' : (msg.replyTo.text | slice:0:50) }}</div>
          </div>

          <!-- Forwarded -->
          <div *ngIf="msg.forwarded" class="forwarded-label">
            <ion-icon name="arrow-redo" style="font-size: 10px;"></ion-icon> Forwarded
          </div>

          <!-- Unified Media Handling -->
          <!-- We rely on msg.text being the Metadata Object if it's media -->

          <!-- IMAGE -->
          <div *ngIf="isMedia(msg.text) && (msg.text.type === 'image' || !msg.text.type)" class="media-content">
            <!-- Normal Image -->
            <ng-container *ngIf="!msg.text.viewOnce">
              <img [secureSrc]="msg.text.url" [pymKey]="isMyMsg(msg) ? (msg.text.ks || msg.text.k) : msg.text.k"
                [pymIv]="msg.text.i" class="message-image" (click)="openImage(msg.text)"
                (error)="$event.target.src = 'assets/placeholder_broken.png'" />
              <p *ngIf="msg.text.caption">{{ msg.text.caption }}</p>
            </ng-container>

            <!-- View Once Image -->
            <div *ngIf="msg.text.viewOnce" class="view-once-content" (click)="openViewOnce(msg, 'image')"
              [class.opened]="msg.viewed">
              <div class="vo-icon">
                <ion-icon name="timer" *ngIf="!msg.viewed && !isMyMsg(msg)"></ion-icon>
                <ion-icon name="radio-button-off" *ngIf="msg.viewed || isMyMsg(msg)"></ion-icon>
              </div>
              <div class="vo-label">
                {{ isMyMsg(msg) ? 'View Once' : (msg.viewed ? 'Opened' : 'Photo') }}
              </div>
            </div>
          </div>

          <!-- VIDEO -->
          <div *ngIf="getMsgType(msg.text) === 'video'" class="media-content">
            <!-- Normal Video -->
            <ng-container *ngIf="!msg.text.viewOnce">
              <video [secureSrc]="msg.text.url" [pymKey]="isMyMsg(msg) ? (msg.text.ks || msg.text.k) : msg.text.k"
                [pymIv]="msg.text.i" controls class="message-video"></video>
              <p *ngIf="msg.text.caption">{{ msg.text.caption }}</p>
            </ng-container>

            <!-- View Once Video -->
            <div *ngIf="msg.text.viewOnce" class="view-once-content" (click)="openViewOnce(msg, 'video')"
              [class.opened]="msg.viewed">
              <div class="vo-icon">
                <ion-icon name="timer" *ngIf="!msg.viewed && !isMyMsg(msg)"></ion-icon>
                <ion-icon name="radio-button-off" *ngIf="msg.viewed || isMyMsg(msg)"></ion-icon>
              </div>
              <div class="vo-label">
                {{ isMyMsg(msg) ? 'View Once' : (msg.viewed ? 'Opened' : 'Video') }}
              </div>
            </div>
          </div>

          <!-- AUDIO -->
          <div *ngIf="getMsgType(msg.text) === 'audio'" class="audio-player-wrapper">
            <div class="audio-row">
              <app-audio-waveform [audioUrl]="msg.text._blobUrl || msg.text.url"
                [audioKey]="isMyMsg(msg) ? (msg.text.ks || msg.text.k) : msg.text.k" [audioIv]="msg.text.i">
              </app-audio-waveform>
              <div class="audio-duration" *ngIf="msg.text.d">{{ formatAudioDuration(msg.text.d) }}</div>
            </div>
          </div>


          <!-- DOCUMENT -->
          <div *ngIf="getMsgType(msg.text) === 'document'" class="document-content" (click)="openDocument(msg.text)">
            <div class="document-icon">
              <ion-icon [name]="getDocIcon(msg.text.mime)"></ion-icon>
            </div>
            <div class="document-info">
              <div class="document-name">{{ msg.text.name || 'Document' }}</div>
              <div class="document-size">{{ formatFileSize(msg.text.size) }}</div>
            </div>
            <ion-icon name="download-outline" class="download-icon"></ion-icon>
          </div>

          <!-- REVOKED / DELETED MESSAGE -->
          <div *ngIf="getMsgType(msg.text) === 'revoked'" class="revoked-content">
            <ion-icon name="ban" slot="start"></ion-icon>
            <span>{{ isMyMsg(msg) ? 'You deleted this message' : 'This message was deleted' }}</span>
          </div>

          <!-- CONTACT -->
          <div *ngIf="getMsgType(msg.text) === 'contact'" class="contact-content">
            <div class="contact-card-inner">
              <ion-avatar class="contact-msg-avatar">
                <img [secureSrc]="msg.text.photo" onerror="this.src='assets/user.png'" />
              </ion-avatar>
              <div class="contact-info">
                <div class="contact-name">{{ msg.text.name }}</div>
                <div class="contact-phones" *ngFor="let p of msg.text.phones">{{ p }}</div>
              </div>
            </div>
            <div class="contact-actions">
              <div class="contact-action-btn" (click)="saveContact(msg.text)">Save</div>
              <div class="contact-action-btn primary" (click)="startChatWithContact(msg.text)">Message</div>
            </div>
          </div>

          <!-- LOCATION -->
          <div *ngIf="getMsgType(msg.text) === 'location'" class="location-content" (click)="openLocation(msg.text)">
            <div class="location-map-preview">
              <!-- Static Map Image from OpenStreetMap -->
              <img [src]="getStaticMapUrl(msg.text.lat, msg.text.lng)" class="static-map-img"
                onerror="this.style.display='none'" />
            </div>
            <div class="location-label">
              <ion-icon name="location-outline"></ion-icon>
              <span>{{ msg.text.label || 'Shared Location' }}</span>
            </div>
          </div>

          <!-- LIVE LOCATION -->
          <div *ngIf="getMsgType(msg.text) === 'live_location'" class="live-location-content" (click)="openLiveMap()">
            <div class="live-location-preview">
              <img [src]="getStaticMapUrl(msg.text.lat, msg.text.lng)" class="static-map-img" />
              <div class="live-badge">
                <ion-icon name="pulse"></ion-icon>
                LIVE
              </div>
            </div>
            <div class="live-location-info">
              <ion-icon name="location-outline"></ion-icon>
              <span>Live location</span>
              <span class="live-remaining" *ngIf="getLiveRemaining(msg.text) > 0">
                â€¢ {{ formatLiveRemaining(msg.text) }}
              </span>
              <span class="live-expired" *ngIf="getLiveRemaining(msg.text) <= 0">
                â€¢ Expired
              </span>
            </div>
          </div>

          <!-- TEXT -->
          <span *ngIf="getMsgType(msg.text) === 'text'" class="msg-text" [innerHTML]="linkify(msg.text)"></span>

          <!-- Reactions -->
          <div class="reaction-badge" *ngIf="getReactionCount(msg) > 0">
            <span *ngFor="let r of getTopReactions(msg)">{{ r }}</span>
            <span class="reaction-count" *ngIf="getReactionCount(msg) > 1">{{ getReactionCount(msg) }}</span>
          </div>

          <!-- Metadata (Time + Status) -->
          <div class="msg-footer">
            <span class="timestamp">{{ msg.timestamp?.seconds * 1000 || msg.timestamp | date:'shortTime' }}</span>
            <ion-icon *ngIf="isMyMsg(msg)" [name]="isRead(msg) ? 'checkmark-done' : 'checkmark-done'"
              [class.read-icon]="isRead(msg)" [class.sent-icon]="!isRead(msg)"></ion-icon>
          </div>

        </div>
      </div>
    </div>
  </ion-list>

  <!-- Scroll FAB -->
  <ion-fab *ngIf="showScrollFab" vertical="bottom" horizontal="end" slot="fixed" class="scroll-fab">
    <ion-fab-button size="small" (click)="scrollToBottom()">
      <ion-icon name="chevron-down"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>

<!-- Footer -->
<ion-footer class="ion-no-border">
  <div *ngIf="replyingTo" class="reply-preview">
    <div class="reply-content">
      <div class="reply-title">Replying to {{ replyingTo.senderName || 'User' }}</div>
      <div class="reply-text">{{ replyingTo.text?.type ? 'Media' : replyingTo.text }}</div>
    </div>
    <ion-button fill="clear" (click)="replyingTo = null">
      <ion-icon name="close" color="medium"></ion-icon>
    </ion-button>
  </div>

  <div class="chat-footer">
    <ion-button fill="clear" class="action-btn emoji-toggle-btn" (click)="toggleEmojiPicker()">
      <ion-icon [name]="showEmojiPicker ? 'keyboard-outline' : 'happy-outline'" slot="icon-only"
        color="medium"></ion-icon>
    </ion-button>

    <div class="input-container">
      <textarea rows="1" placeholder="Message" [(ngModel)]="newMessage" (ngModelChange)="onTyping()"
        (focus)="onInputFocus()" class="chat-input"></textarea>
      <ion-button fill="clear" class="action-btn" (click)="presentAttachmentMenu()">
        <ion-icon name="attach" slot="icon-only" style="transform: rotate(45deg);"></ion-icon>
      </ion-button>
      <ion-button *ngIf="!newMessage" fill="clear" class="action-btn" style="margin-left: -5px;"
        (click)="captureMedia()">
        <ion-icon name="camera" slot="icon-only"></ion-icon>
      </ion-button>
    </div>
    <!-- Recording Overlay -->
    <div class="recording-overlay" *ngIf="isRecording" (touchmove)="onRecordingMove($event)"
      (mousemove)="onRecordingMove($event)" (touchend)="endRecordingTouch()" (mouseup)="endRecordingTouch()">
      <div class="recording-content" [class.cancelled]="recordCancelled">
        <ion-icon name="mic" class="recording-mic-icon"></ion-icon>
        <span class="recording-time">{{ recordDuration | number:'1.0-0' }}s</span>
        <span class="swipe-hint" *ngIf="!recordCancelled">
          <ion-icon name="chevron-back"></ion-icon> Slide to cancel
        </span>
        <span class="cancel-hint" *ngIf="recordCancelled">
          <ion-icon name="close-circle"></ion-icon> Release to cancel
        </span>
      </div>
    </div>

    <!-- Record or Send Button -->
    <div class="mic-btn" *ngIf="!newMessage && !isRecording" (touchstart)="startRecordingTouch($event)"
      (mousedown)="startRecordingTouch($event)">
      <ion-icon name="mic"></ion-icon>
    </div>
    <div class="send-btn" *ngIf="newMessage" (click)="sendMessage()">
      <ion-icon name="send"></ion-icon>
    </div>
  </div>

  <!-- Emoji Picker -->
  <div *ngIf="showEmojiPicker" class="emoji-picker-container">
    <app-emoji-picker (emojiSelect)="addEmojiDirect($event)"></app-emoji-picker>
  </div>
</ion-footer>