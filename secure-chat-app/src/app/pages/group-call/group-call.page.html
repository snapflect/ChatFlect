<ion-content [fullscreen]="true" class="call-content">

  <!-- INCOMING CALL -->
  <div *ngIf="(callService.callStatus | async) === 'incoming'" class="overlay-container incoming">
    <div class="ion-text-center">
      <ion-avatar class="caller-avatar">
        <img [secureSrc]="callerPhoto" />
      </ion-avatar>
      <h2>{{ callerName }}</h2>
      <p class="status-subtitle">
        <ion-icon [name]="callService.activeCallType === 'video' ? 'videocam' : 'call'"></ion-icon>
        Incoming {{ callService.activeCallType === 'video' ? 'Video' : 'Audio' }} Call
      </p>
      <div class="encrypted-badge">
        <ion-icon name="lock-closed"></ion-icon> End-to-End Encrypted
      </div>

      <div class="actions">
        <ion-button shape="round" color="danger" (click)="callService.declineCall()">
          <ion-icon name="close"></ion-icon>
        </ion-button>
        <ion-button shape="round" color="success" (click)="callService.answerCall()">
          <ion-icon name="call"></ion-icon>
        </ion-button>
      </div>
    </div>
  </div>

  <!-- CALLING -->
  <div *ngIf="(callService.callStatus | async) === 'calling'" class="calling-overlay">
    <div class="ion-text-center">
      <ion-avatar class="caller-avatar">
        <img [secureSrc]="callerPhoto" />
      </ion-avatar>
      <h2>{{ callerName }}</h2>
      <p class="status-subtitle">Calling...</p>

      <div class="calling-actions">
        <ion-button shape="round" color="danger" (click)="endCall()">
          <ion-icon name="call-outline"></ion-icon>
        </ion-button>
      </div>
    </div>

    <!-- Show Local Video Preview While Calling -->
    <div class="local-preview" *ngIf="localStream && callService.activeCallType === 'video'">
      <video [srcObject]="localStream" autoplay playsinline muted controls="false" class="local-video-mini"></video>
    </div>
  </div>

  <!-- DECLINED / BUSY -->
  <div *ngIf="(callService.callStatus | async) === 'declined' || (callService.callStatus | async) === 'busy'"
    class="overlay-container feedback">
    <div class="ion-text-center">
      <ion-avatar class="caller-avatar">
        <img [secureSrc]="callerPhoto" />
      </ion-avatar>
      <h2>{{ callerName }}</h2>
      <h3 class="feedback-text">{{ (callService.callStatus | async) === 'declined' ? 'Call Declined' : 'User is Busy' }}
      </h3>
      <ion-icon [name]="(callService.callStatus | async) === 'declined' ? 'close-circle' : 'time'" size="large"
        color="danger"></ion-icon>
    </div>
  </div>

  <!-- CONNECTED GRID -->
  <!-- CONNECTED: VIDEO MODE -->
  <div *ngIf="(callService.callStatus | async) === 'connected' && callService.activeCallType === 'video'"
    class="video-grid">
    <!-- Remote Peers -->
    <div class="remote-wrapper" *ngFor="let peer of asArray(remoteStreams); trackBy: trackByPeerId"
      [class.single]="remoteStreams.size === 1">
      <video [srcObject]="peer[1]" autoplay playsinline controls="false" class="remote-video"></video>
    </div>

    <!-- Local Self View (Floating) -->
    <div class="local-wrapper">
      <video [srcObject]="localStream" autoplay playsinline muted controls="false" class="local-video"></video>
    </div>
  </div>

  <!-- CONNECTED: AUDIO MODE -->
  <!-- CONNECTED: AUDIO MODE -->
  <div *ngIf="(callService.callStatus | async) === 'connected' && callService.activeCallType === 'audio'"
    class="audio-connected" [class.grid-mode]="remoteStreams.size > 1">

    <!-- 1:1 Call View (Single Peer) -->
    <div class="ion-text-center" *ngIf="remoteStreams.size <= 1">
      <div class="avatar-ripple animate-pulse">
        <ion-avatar class="large-avatar">
          <img [secureSrc]="callerPhoto" />
        </ion-avatar>
      </div>
      <h2>{{ callerName }}</h2>
      <div class="timer-badge">{{ callDuration }}</div>
      <p class="status-subtitle">Audio Call Encrypted</p>
    </div>

    <!-- Group Call Grid View (> 1 Peer) -->
    <div class="participants-grid" *ngIf="remoteStreams.size > 1" [class.large-group]="remoteStreams.size > 8">
      <!-- Me -->
      <div class="participant-tile" [class.talking]="micEnabled">
        <ion-avatar><img src="assets/user.png" /></ion-avatar>
        <span>Me</span>
      </div>
      <!-- Remotes -->
      <div class="participant-tile" *ngFor="let peer of asArray(remoteStreams); trackBy: trackByPeerId"
        [class.talking]="activeSpeakerId === peer[0]">
        <ion-avatar><img [src]="'assets/user.png'" /></ion-avatar>
        <!-- In real app, we need a pipe to fetch name by ID or pre-fetch participant info -->
        <span>Peer {{peer[0].slice(-4)}}</span>

        <!-- Hidden Audio Element -->
        <audio [srcObject]="peer[1]" autoplay playsinline></audio>
      </div>
    </div>

    <!-- Hidden Audio Playback for 1:1 (Grid has its own inside loop) -->
    <div *ngIf="remoteStreams.size <= 1">
      <div *ngFor="let peer of asArray(remoteStreams); trackBy: trackByPeerId" style="display: none">
        <audio [srcObject]="peer[1]" autoplay playsinline controls="false"></audio>
      </div>
    </div>
  </div>

  <!-- GLOBAL CONTROLS (Common for Connected State) -->
  <div *ngIf="(callService.callStatus | async) === 'connected'" class="controls-overlay-wrapper">
    <!-- Video Timer Overlay (Top Center) -->
    <div *ngIf="callService.activeCallType === 'video'" class="video-timer glass-card">
      {{ callDuration }}
    </div>

    <div class="controls-bar glass-card">
      <!-- Timer removed from here -->

      <ion-button *ngIf="callService.activeCallType === 'video'" fill="clear" (click)="toggleVideo()">
        <ion-icon [name]="videoEnabled ? 'videocam' : 'videocam-off'"></ion-icon>
      </ion-button>

      <ion-button fill="clear" (click)="toggleMic()">
        <ion-icon [name]="micEnabled ? 'mic' : 'mic-off'"></ion-icon>
      </ion-button>

      <ion-button fill="clear" (click)="toggleSpeaker()">
        <ion-icon [name]="speakerEnabled ? 'volume-high' : 'volume-low'"></ion-icon>
      </ion-button>

      <!-- Camera Flip only for Video -->
      <ion-button *ngIf="callService.activeCallType === 'video'" fill="clear" (click)="switchCamera()">
        <ion-icon name="camera-reverse"></ion-icon>
      </ion-button>

      <ion-button fill="clear" color="danger" (click)="endCall()">
        <ion-icon name="call" class="rotate-down"></ion-icon>
      </ion-button>
    </div>
  </div>

  <!-- Hold Indicator -->
  <div *ngIf="callService.isOnHold | async" class="hold-overlay glass-card">
    <ion-icon name="pause-circle" size="large"></ion-icon>
    <p>CALL ON HOLD</p>
  </div>

</ion-content>