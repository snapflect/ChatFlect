<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-title class="gradient-text">Your Profile</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="saveProfile()" class="vibrant-icon-btn">
        <ion-icon name="checkmark-done-circle" color="secondary" style="font-size: 28px;"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="profile-header ion-text-center">
    <div class="avatar-container">
      <ion-avatar class="profile-avatar" (click)="viewPhoto()">
        <img [secureSrc]="profile.photo_url || 'assets/placeholder_user.png'" (error)="onImageError($event)" />
      </ion-avatar>
      <ion-button fill="clear" class="change-photo-btn" (click)="changePhoto()">
        <ion-icon name="camera" slot="icon-only"></ion-icon>
      </ion-button>
    </div>
  </div>

  <div class="ion-padding">
    <div class="glass-card ion-padding">
      <ion-item lines="none" class="custom-input">
        <ion-label position="stacked" color="secondary">First Name</ion-label>
        <ion-input [(ngModel)]="profile.first_name" placeholder="John"></ion-input>
      </ion-item>

      <ion-item lines="none" class="custom-input">
        <ion-label position="stacked" color="secondary">Last Name</ion-label>
        <ion-input [(ngModel)]="profile.last_name" placeholder="Doe"></ion-input>
      </ion-item>

      <ion-item lines="none" class="custom-input">
        <ion-label position="stacked" color="secondary">Phone Number (Mandatory)</ion-label>
        <div style="display: flex; align-items: center; width: 100%;">
          <ion-input [(ngModel)]="profile.phone_number" placeholder="+1234567890"
            [disabled]="profile.is_profile_complete == 1 && !isEditingPhone" style="flex: 1;"></ion-input>

          <ion-button *ngIf="profile.is_profile_complete == 1 && !isEditingPhone" fill="clear"
            (click)="startPhoneEdit()">
            <ion-icon name="create-outline" slot="icon-only"></ion-icon>
          </ion-button>

          <ion-button *ngIf="isEditingPhone" fill="clear" color="success" (click)="requestPhoneUpdateOtp()">
            <ion-icon name="send-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>
      </ion-item>

      <div *ngIf="showPhoneOtpInput" class="ion-margin-top anim-fade-in">
        <ion-item lines="none" class="custom-input">
          <ion-label position="stacked" color="tertiary">Enter Email OTP to Verify New Phone</ion-label>
          <ion-input [(ngModel)]="phoneOtp" placeholder="6-digit code"></ion-input>
        </ion-item>
        <ion-button expand="block" fill="outline" size="small" (click)="verifyPhoneUpdate()">
          Confirm New Phone
        </ion-button>
      </div>

      <ion-item lines="none" class="custom-input">
        <ion-label position="stacked" color="secondary">Short Note</ion-label>
        <ion-textarea [(ngModel)]="profile.short_note" rows="3"
          placeholder="Hey there! I am using Secure Chat."></ion-textarea>
      </ion-item>

      <ion-button expand="block" shape="round" class="vibrant-btn ion-margin-top" (click)="saveProfile()"
        [disabled]="!profile.phone_number || showPhoneOtpInput">
        Save Profile
      </ion-button>

      <!-- v13: Key Rotation -->
      <ion-button expand="block" shape="round" fill="outline" color="medium" class="ion-margin-top"
        (click)="rotateEncryptionKeys()">
        <ion-icon name="key-outline" slot="start"></ion-icon>
        Rotate Encryption Keys
      </ion-button>
    </div>
  </div>
</ion-content>